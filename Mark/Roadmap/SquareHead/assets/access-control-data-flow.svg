<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1000" width="1400" height="1000">
  <defs>
    <!-- Arrow markers -->
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f97316"/>
    </marker>
    <marker id="arrowGray" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#6b7280"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1400" height="1000" fill="#ffffff"/>

  <!-- Title -->
  <text x="700" y="40" font-family="system-ui, -apple-system, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#111827">ACCESS CONTROL DATA FLOW</text>

  <!-- ==================== ACTORS ==================== -->

  <!-- USER Actor -->
  <rect x="180" y="70" width="140" height="60" rx="8" fill="#dbeafe" stroke="#3b82f6" stroke-width="2"/>
  <text x="250" y="97" font-family="system-ui, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#1e40af">USER</text>
  <text x="250" y="117" font-family="system-ui, sans-serif" font-size="12" text-anchor="middle" fill="#3b82f6">(Browser)</text>

  <!-- AI AGENT Actor -->
  <rect x="1080" y="70" width="140" height="60" rx="8" fill="#ffedd5" stroke="#f97316" stroke-width="2"/>
  <text x="1150" y="97" font-family="system-ui, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#c2410c">AI AGENT</text>
  <text x="1150" y="117" font-family="system-ui, sans-serif" font-size="12" text-anchor="middle" fill="#ea580c">(Celery)</text>

  <!-- Arrows from actors -->
  <path d="M250 130 L250 160" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <path d="M1150 130 L1150 160" stroke="#f97316" stroke-width="2" marker-end="url(#arrowOrange)"/>

  <!-- ==================== ENTRY POINTS ==================== -->

  <!-- REST API Box -->
  <rect x="80" y="170" width="340" height="150" rx="8" fill="#f0fdf4" stroke="#22c55e" stroke-width="2"/>
  <text x="250" y="195" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#166534">REST API (DRF Views)</text>
  <line x1="100" y1="210" x2="400" y2="210" stroke="#86efac" stroke-width="1"/>
  <text x="100" y="235" font-family="system-ui, sans-serif" font-size="12" fill="#16a34a">✓ TeamScopedPermission</text>
  <text x="100" y="255" font-family="system-ui, sans-serif" font-size="12" fill="#16a34a">✓ Sets tenant ContextVar</text>
  <text x="100" y="275" font-family="system-ui, sans-serif" font-size="12" fill="#16a34a">✓ Validates team membership</text>
  <text x="100" y="295" font-family="system-ui, sans-serif" font-size="12" fill="#dc2626">✗ No ABAC</text>
  <text x="260" y="295" font-family="system-ui, sans-serif" font-size="12" fill="#dc2626">✗ No ownership check</text>

  <!-- Agent Tools Box -->
  <rect x="980" y="170" width="340" height="150" rx="8" fill="#fff7ed" stroke="#f97316" stroke-width="2"/>
  <text x="1150" y="195" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#c2410c">Agent Tools</text>
  <text x="1150" y="215" font-family="system-ui, sans-serif" font-size="12" text-anchor="middle" fill="#ea580c">hybrid_search()</text>
  <line x1="1000" y1="225" x2="1300" y2="225" stroke="#fed7aa" stroke-width="1"/>
  <text x="1000" y="250" font-family="system-ui, sans-serif" font-size="12" fill="#6b7280">HookContext available:</text>
  <text x="1020" y="270" font-family="system-ui, sans-serif" font-size="12" fill="#16a34a">• team_id ✓</text>
  <text x="1020" y="290" font-family="system-ui, sans-serif" font-size="12" fill="#16a34a">• user_id ✓</text>
  <text x="1000" y="310" font-family="system-ui, sans-serif" font-size="12" fill="#dc2626">✗ Tools IGNORE context</text>

  <!-- ==================== SERVICE LAYER ==================== -->

  <!-- Arrows from REST API to services -->
  <path d="M140 320 L140 380" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <path d="M250 320 L250 380" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <path d="M360 320 L360 380" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>

  <!-- Labels on arrows -->
  <text x="110" y="355" font-family="system-ui, sans-serif" font-size="10" fill="#6b7280">Django</text>
  <text x="110" y="367" font-family="system-ui, sans-serif" font-size="10" fill="#6b7280">Models</text>
  <text x="230" y="355" font-family="system-ui, sans-serif" font-size="10" fill="#6b7280">Search</text>
  <text x="230" y="367" font-family="system-ui, sans-serif" font-size="10" fill="#6b7280">queries</text>
  <text x="340" y="355" font-family="system-ui, sans-serif" font-size="10" fill="#6b7280">Platform</text>
  <text x="340" y="367" font-family="system-ui, sans-serif" font-size="10" fill="#6b7280">Group</text>

  <!-- Arrow from Agent Tools to Search Service -->
  <path d="M1150 320 L1150 380" stroke="#f97316" stroke-width="2" marker-end="url(#arrowOrange)"/>
  <text x="1100" y="355" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">Search only</text>
  <text x="1100" y="367" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">(no context!)</text>

  <!-- Service boxes -->
  <!-- Django ORM -->
  <rect x="80" y="390" width="120" height="50" rx="6" fill="#eff6ff" stroke="#6b7280" stroke-width="1"/>
  <text x="140" y="415" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#374151">Django</text>
  <text x="140" y="430" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#374151">ORM</text>

  <!-- Search Service (User path) -->
  <rect x="210" y="390" width="120" height="50" rx="6" fill="#eff6ff" stroke="#6b7280" stroke-width="1"/>
  <text x="270" y="415" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#374151">Search</text>
  <text x="270" y="430" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#374151">Service</text>

  <!-- PlatformGroup RecordService -->
  <rect x="340" y="390" width="140" height="50" rx="6" fill="#eff6ff" stroke="#6b7280" stroke-width="1"/>
  <text x="410" y="415" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#374151">PlatformGroup</text>
  <text x="410" y="430" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#374151">RecordService</text>

  <!-- Search Service (Agent path) -->
  <rect x="1090" y="390" width="120" height="50" rx="6" fill="#fff7ed" stroke="#f97316" stroke-width="2"/>
  <text x="1150" y="415" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#c2410c">Search</text>
  <text x="1150" y="430" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#c2410c">Service</text>

  <!-- ==================== STORAGE LAYER ==================== -->

  <!-- Arrows to storage -->
  <path d="M140 440 L140 500" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <path d="M270 440 L270 500" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <path d="M410 440 L410 500" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <path d="M1150 440 L1150 500" stroke="#f97316" stroke-width="2" marker-end="url(#arrowOrange)"/>

  <!-- PostgreSQL (Platform Config) -->
  <rect x="70" y="510" width="140" height="100" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/>
  <text x="140" y="530" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#374151">PostgreSQL</text>
  <text x="140" y="543" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#6b7280">(platform config)</text>
  <line x1="80" y1="552" x2="200" y2="552" stroke="#d1d5db" stroke-width="1"/>
  <text x="80" y="568" font-family="system-ui, sans-serif" font-size="10" fill="#16a34a">✓ Tenant FK</text>
  <text x="80" y="583" font-family="system-ui, sans-serif" font-size="10" fill="#16a34a">✓ QuerySet.filter()</text>
  <text x="80" y="598" font-family="system-ui, sans-serif" font-size="10" fill="#6b7280">Users, Tenants, CDC</text>

  <!-- Qdrant + Meilisearch (User path) -->
  <rect x="220" y="510" width="160" height="100" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/>
  <text x="300" y="530" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#374151">Qdrant + Meilisearch</text>
  <text x="300" y="545" font-family="system-ui, sans-serif" font-size="10" text-anchor="middle" fill="#6b7280">(search)</text>
  <line x1="230" y1="555" x2="370" y2="555" stroke="#d1d5db" stroke-width="1"/>
  <text x="230" y="575" font-family="system-ui, sans-serif" font-size="10" fill="#16a34a">✓ bucket_name filter</text>
  <text x="230" y="590" font-family="system-ui, sans-serif" font-size="10" fill="#ca8a04">⚠ team_id (optional)</text>
  <text x="230" y="605" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">✗ owner filtering</text>

  <!-- TerminusDB -->
  <rect x="390" y="510" width="150" height="100" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="2"/>
  <text x="465" y="532" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" text-anchor="middle" fill="#374151">TerminusDB</text>
  <text x="465" y="545" font-family="system-ui, sans-serif" font-size="9" text-anchor="middle" fill="#6b7280">(graph documents)</text>
  <line x1="400" y1="553" x2="530" y2="553" stroke="#d1d5db" stroke-width="1"/>
  <text x="400" y="570" font-family="system-ui, sans-serif" font-size="10" fill="#16a34a">✓ tenant context</text>
  <text x="400" y="585" font-family="system-ui, sans-serif" font-size="10" fill="#ca8a04">⚠ team_id (optional)</text>
  <text x="400" y="600" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">✗ owner filtering</text>

  <!-- Qdrant + Meilisearch (Agent path - UNFILTERED) -->
  <rect x="1070" y="510" width="160" height="100" rx="6" fill="#fef2f2" stroke="#dc2626" stroke-width="3"/>
  <text x="1150" y="530" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#991b1b">Qdrant + Meilisearch</text>
  <text x="1150" y="545" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" text-anchor="middle" fill="#dc2626">(UNFILTERED!)</text>
  <line x1="1080" y1="555" x2="1220" y2="555" stroke="#fca5a5" stroke-width="1"/>
  <text x="1080" y="575" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">✗ No team filter</text>
  <text x="1080" y="590" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626">✗ No user filter</text>
  <text x="1080" y="605" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#dc2626">✗ Returns ALL data</text>

  <!-- ==================== WHO ACCESSES WHAT ==================== -->

  <!-- Divider line -->
  <line x1="50" y1="650" x2="1350" y2="650" stroke="#d1d5db" stroke-width="2" stroke-dasharray="8,4"/>

  <!-- Summary box -->
  <rect x="50" y="670" width="1300" height="240" rx="8" fill="#f9fafb" stroke="#6b7280" stroke-width="1"/>
  <text x="700" y="700" font-family="system-ui, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#111827">WHO ACCESSES WHAT</text>

  <!-- User section -->
  <text x="80" y="735" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#1e40af">USER (via REST API):</text>
  <text x="100" y="760" font-family="system-ui, sans-serif" font-size="12" fill="#374151">├── Django ORM → PostgreSQL</text>
  <text x="380" y="760" font-family="system-ui, sans-serif" font-size="11" fill="#6b7280">(Platform config: Users, Tenants, CDC configs)</text>
  <text x="100" y="780" font-family="system-ui, sans-serif" font-size="12" fill="#374151">├── SearchService → Qdrant/Meilisearch</text>
  <text x="380" y="780" font-family="system-ui, sans-serif" font-size="11" fill="#6b7280">(Document search)</text>
  <text x="100" y="800" font-family="system-ui, sans-serif" font-size="12" fill="#374151">└── PlatformGroupRecordService → TerminusDB</text>
  <text x="440" y="800" font-family="system-ui, sans-serif" font-size="11" fill="#6b7280">(CRM records, Luminous data)</text>

  <!-- Agent section -->
  <text x="80" y="840" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#c2410c">AI AGENT (via Tools):</text>
  <text x="100" y="865" font-family="system-ui, sans-serif" font-size="12" fill="#374151">├── hybrid_search() → SearchService → Qdrant/Meilisearch</text>
  <text x="520" y="865" font-family="system-ui, sans-serif" font-size="11" fill="#dc2626">(Document search ONLY - UNFILTERED)</text>
  <text x="100" y="885" font-family="system-ui, sans-serif" font-size="12" fill="#dc2626">└── ✗ NO tools for Django ORM</text>
  <text x="100" y="905" font-family="system-ui, sans-serif" font-size="12" fill="#dc2626">└── ✗ NO tools for PlatformGroupRecordService</text>

  <!-- ==================== LEGEND ==================== -->
  <rect x="50" y="930" width="1300" height="50" rx="6" fill="#f3f4f6" stroke="#6b7280" stroke-width="1"/>
  <text x="80" y="960" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#374151">LEGEND:</text>
  <text x="170" y="960" font-family="system-ui, sans-serif" font-size="12" fill="#16a34a">✓ Enforced</text>
  <text x="300" y="960" font-family="system-ui, sans-serif" font-size="12" fill="#ca8a04">⚠ Partial/Optional</text>
  <text x="490" y="960" font-family="system-ui, sans-serif" font-size="12" fill="#dc2626">✗ Missing/Not Implemented</text>

  <!-- Color indicators in legend -->
  <rect x="750" y="945" width="20" height="20" rx="3" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
  <text x="780" y="960" font-family="system-ui, sans-serif" font-size="11" fill="#374151">User path</text>
  <rect x="880" y="945" width="20" height="20" rx="3" fill="#ffedd5" stroke="#f97316" stroke-width="1"/>
  <text x="910" y="960" font-family="system-ui, sans-serif" font-size="11" fill="#374151">Agent path</text>
  <rect x="1010" y="945" width="20" height="20" rx="3" fill="#fef2f2" stroke="#dc2626" stroke-width="2"/>
  <text x="1040" y="960" font-family="system-ui, sans-serif" font-size="11" fill="#374151">Security gap</text>

</svg>
